<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - IPSAS System</title>
    <style>
        <?!= include('css/main.css.html'); ?>
        <?!= include('src/frontend/css/dashboard.css.html'); ?>

        .reports-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Category Tabs */
        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            overflow-x: auto;
            border-bottom: 2px solid #e5e7eb;
        }

        .category-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .category-tab:hover {
            color: #374151;
            background: #f9fafb;
        }

        .category-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* Report Cards Grid */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .report-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .report-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .report-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .report-name {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .report-description {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 15px;
        }

        .report-formats {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .format-badge {
            padding: 4px 10px;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
        }

        .param-group {
            margin-bottom: 20px;
        }

        .param-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .param-input, .param-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }

        .param-input:focus, .param-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .reports-grid {
                grid-template-columns: 1fr;
            }
            .category-tabs {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1>IPSAS Financial Consolidation System</h1>
                <div class="user-info">
                    <span><?= user.name ?></span>
                    <span class="role-badge"><?= user.role ?></span>
                    <button onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <main class="reports-container">
        <h2 style="margin-bottom: 20px; color: #1f2937;">Reports</h2>

        <div class="category-tabs" id="category-tabs"></div>
        <div class="reports-grid" id="reports-grid"></div>
    </main>

    <!-- Report Parameters Modal -->
    <div class="modal" id="report-modal">
        <div class="modal-content">
            <div class="modal-header" id="modal-title">Generate Report</div>
            <div id="modal-body"></div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="generateReport()">Generate</button>
            </div>
        </div>
    </div>

    <script>
        let allReports = [];
        let categories = [];
        let currentCategory = 'all';
        let selectedReport = null;
        let entityId = '<?= session.entityId ?>';
        let userRole = '<?= user.role ?>';

        window.addEventListener('DOMContentLoaded', function() {
            loadReports();
        });

        function loadReports() {
            document.getElementById('reports-grid').innerHTML = '<div class="loading"><div class="spinner"></div><p style="margin-top: 15px; color: #6b7280;">Loading reports...</p></div>';

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        allReports = result.reports;
                        categories = result.categories;
                        renderCategories();
                        renderReports();
                    } else {
                        showError('Failed to load reports: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    showError('Error loading reports: ' + error.message);
                })
                .getAvailableReports({ userId: '<?= user.userId ?>' });
        }

        function renderCategories() {
            const tabsContainer = document.getElementById('category-tabs');
            let html = '<button class="category-tab active" onclick="filterByCategory(\'all\')">üìã All Reports</button>';

            categories.forEach(cat => {
                html += `<button class="category-tab" onclick="filterByCategory('${cat.id}')">${cat.icon} ${cat.name}</button>`;
            });

            tabsContainer.innerHTML = html;
        }

        function filterByCategory(categoryId) {
            currentCategory = categoryId;
            document.querySelectorAll('.category-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderReports();
        }

        function renderReports() {
            const grid = document.getElementById('reports-grid');
            const filtered = currentCategory === 'all'
                ? allReports
                : allReports.filter(r => r.category === currentCategory);

            if (filtered.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #6b7280;"><p>No reports available in this category</p></div>';
                return;
            }

            let html = '';
            filtered.forEach(report => {
                html += `
                    <div class="report-card" onclick='openReportModal(${JSON.stringify(report)})'>
                        <div class="report-icon">${report.icon}</div>
                        <div class="report-name">${report.name}</div>
                        <div class="report-description">${report.description}</div>
                        <div class="report-formats">
                            ${report.formats.map(f => `<span class="format-badge">${f}</span>`).join('')}
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        function openReportModal(report) {
            selectedReport = report;
            document.getElementById('modal-title').textContent = report.name;

            let html = '<p style="color: #6b7280; margin-bottom: 20px;">' + report.description + '</p>';

            // Entity selector if required
            if (report.requiresEntity) {
                html += `
                    <div class="param-group">
                        <label class="param-label">Entity ${entityId ? '(Current: ' + entityId + ')' : ''}</label>
                        <select class="param-select" id="param-entity">
                            ${entityId ? `<option value="${entityId}">Current Entity</option>` : '<option value="">Select Entity...</option>'}
                        </select>
                    </div>
                `;
            }

            // Period selector
            if (report.requiresPeriod) {
                html += `
                    <div class="param-group">
                        <label class="param-label">Period</label>
                        <select class="param-select" id="param-period">
                            <option value="">Select Period...</option>
                        </select>
                    </div>
                `;
            }

            // Format selector
            html += `
                <div class="param-group">
                    <label class="param-label">Export Format</label>
                    <select class="param-select" id="param-format">
                        ${report.formats.map(f => `<option value="${f}">${f}</option>`).join('')}
                    </select>
                </div>
            `;

            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('report-modal').classList.add('active');

            // Load periods
            if (report.requiresPeriod) {
                loadPeriods();
            }
        }

        function loadPeriods() {
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success && result.periods) {
                        const select = document.getElementById('param-period');
                        result.periods.forEach(period => {
                            const option = document.createElement('option');
                            option.value = period.periodId;
                            option.textContent = period.name + ' (' + period.year + ')';
                            select.appendChild(option);
                        });
                    }
                })
                .getAllPeriods();
        }

        function closeModal() {
            document.getElementById('report-modal').classList.remove('active');
            selectedReport = null;
        }

        function generateReport() {
            if (!selectedReport) return;

            const periodId = document.getElementById('param-period')?.value;
            const format = document.getElementById('param-format')?.value || 'PDF';
            const entity = selectedReport.requiresEntity ? (document.getElementById('param-entity')?.value || entityId) : null;

            if (selectedReport.requiresPeriod && !periodId) {
                alert('Please select a period');
                return;
            }

            closeModal();

            // Navigate to statement viewer
            if (selectedReport.id.startsWith('statement_')) {
                window.location.href = `?page=Statements&reportId=${selectedReport.id}&entityId=${entity}&periodId=${periodId}&format=${format}`;
            } else {
                // For other reports, trigger download
                alert('Report generation started. This feature is being enhanced.');
            }
        }

        function showError(message) {
            document.getElementById('reports-grid').innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 60px;">
                    <div style="font-size: 48px; color: #ef4444; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <div style="font-size: 18px; font-weight: 600; color: #ef4444; margin-bottom: 8px;">Error</div>
                    <div style="color: #6b7280;">${message}</div>
                    <button class="btn btn-primary" onclick="loadReports()" style="margin-top: 20px;">Retry</button>
                </div>
            `;
        }

        function logout() {
            google.script.run
                .withSuccessHandler(function() {
                    window.location.href = '?page=index';
                })
                .handleLogout();
        }
    </script>
</body>
</html>
