<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAGAs Consolidation Tool - IPSAS Financial Reporting System</title>
    <style>
        <?!= include('css/main.css.html'); ?>
        <?!= include('css/mobile.css.html'); ?>
    </style>
</head>
<body>
    <!-- Header Section -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" width="60" height="60" class="logo-image">
                        <!-- Kenya Coat of Arms Placeholder -->
                        <path d="M100,20 L160,50 L160,120 Q160,160 100,180 Q40,160 40,120 L40,50 Z"
                              fill="#006600" stroke="#000000" stroke-width="2"/>
                        <rect x="40" y="60" width="120" height="15" fill="#000000"/>
                        <rect x="40" y="90" width="120" height="15" fill="#CC0000"/>
                        <rect x="40" y="75" width="120" height="15" fill="#FFFFFF"/>
                        <line x1="80" y1="30" x2="80" y2="160" stroke="#8B4513" stroke-width="3"/>
                        <line x1="120" y1="30" x2="120" y2="160" stroke="#8B4513" stroke-width="3"/>
                        <polygon points="80,25 75,35 85,35" fill="#C0C0C0"/>
                        <polygon points="120,25 115,35 125,35" fill="#C0C0C0"/>
                        <text x="100" y="195" font-family="Arial, sans-serif" font-size="12"
                              text-anchor="middle" fill="#000000" font-weight="bold">KENYA</text>
                    </svg>
                </div>
                <div class="title-section">
                    <h1 class="system-title">SAGAs Consolidation Tool</h1>
                    <p class="system-subtitle">IPSAS Financial Reporting System</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Login Section -->
            <section class="login-section">
                <div class="login-box">
                    <h2 class="login-title">Login to SAGAs</h2>
                    <form class="login-form" id="loginForm">
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input
                                type="email"
                                id="email"
                                name="email"
                                class="form-input"
                                placeholder="Enter your email"
                                required
                            >
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input
                                type="password"
                                id="password"
                                name="password"
                                class="form-input"
                                placeholder="Enter your password"
                                required
                            >
                        </div>
                        <button type="submit" class="btn-login">Login</button>
                        <div class="form-footer">
                            <a href="#" class="forgot-password">Forgot Password?</a>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Info Section -->
            <section class="info-section">
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-label">Current Period</div>
                        <div class="info-value">Q2 2024-25</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Submission Deadline</div>
                        <div class="info-value">December 31, 2024</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Entities Submitted</div>
                        <div class="info-value">
                            <span class="submission-count">680/750</span>
                            <span class="submission-percent">(91%)</span>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <p class="footer-text">&copy; 2024 National Treasury of Kenya</p>
                <p class="footer-version">Version 1.0</p>
            </div>
        </div>
    </footer>

    <!-- Password Change Modal -->
    <div id="passwordChangeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 8px; max-width: 450px; width: 90%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0; color: #333;">Change Password</h2>
            <p id="passwordChangeMessage" style="color: #d32f2f; margin-bottom: 20px; font-weight: bold;"></p>
            <form id="passwordChangeForm">
                <div style="margin-bottom: 15px;">
                    <label for="currentPassword" style="display: block; margin-bottom: 5px; color: #555;">Current Password</label>
                    <input type="password" id="currentPassword" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="newPassword" style="display: block; margin-bottom: 5px; color: #555;">New Password</label>
                    <input type="password" id="newPassword" required minlength="8" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                    <small style="color: #666;">Minimum 8 characters</small>
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="confirmPassword" style="display: block; margin-bottom: 5px; color: #555;">Confirm New Password</label>
                    <input type="password" id="confirmPassword" required minlength="8" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" id="cancelPasswordChange" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
                    <button type="submit" style="padding: 10px 20px; border: none; background: #1976d2; color: white; border-radius: 4px; cursor: pointer;">Change Password</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUserEmail = null;

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = event.target.querySelector('.btn-login');

            // Disable button
            loginBtn.disabled = true;
            loginBtn.textContent = 'Logging in...';

            // Call Google Apps Script function
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        // Check if password needs to be changed
                        if (result.requirePasswordChange) {
                            currentUserEmail = email;
                            document.getElementById('currentPassword').value = password;
                            showPasswordChangeModal('You must change your password before continuing. Please set a new secure password.');
                            loginBtn.disabled = false;
                            loginBtn.textContent = 'Login';
                        } else {
                            // Redirect to appropriate page based on role
                            window.location.href = '?page=' + result.redirectTo;
                        }
                    } else {
                        alert('Login Failed: ' + result.error);
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Login';
                    }
                })
                .withFailureHandler(function(error) {
                    alert('An error occurred: ' + error.message);
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Login';
                })
                .handleLogin({ email: email, password: password });
        });

        // Handle forgot password
        document.querySelector('.forgot-password').addEventListener('click', function(event) {
            event.preventDefault();
            const email = prompt('Enter your email address:');
            if (email) {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            alert('Password reset link sent to your email.');
                        } else {
                            alert('Error: ' + result.error);
                        }
                    })
                    .withFailureHandler(function(error) {
                        alert('An error occurred: ' + error.message);
                    })
                    .resetPassword(email);
            }
        });

        // Password Change Modal Functions
        function showPasswordChangeModal(message) {
            const modal = document.getElementById('passwordChangeModal');
            const messageEl = document.getElementById('passwordChangeMessage');
            messageEl.textContent = message || '';
            modal.style.display = 'flex';
        }

        function hidePasswordChangeModal() {
            const modal = document.getElementById('passwordChangeModal');
            modal.style.display = 'none';
            document.getElementById('passwordChangeForm').reset();
            document.getElementById('passwordChangeMessage').textContent = '';
            currentUserEmail = null;
        }

        // Handle password change form submission
        document.getElementById('passwordChangeForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitBtn = event.target.querySelector('button[type="submit"]');

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }

            // Validate password length
            if (newPassword.length < 8) {
                alert('Password must be at least 8 characters long!');
                return;
            }

            // Disable button
            submitBtn.disabled = true;
            submitBtn.textContent = 'Changing...';

            // Call Google Apps Script function
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        alert('Password changed successfully! Please login with your new password.');
                        hidePasswordChangeModal();
                        // Optionally redirect or reload
                        window.location.href = '?page=index';
                    } else {
                        alert('Password change failed: ' + result.error);
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Change Password';
                    }
                })
                .withFailureHandler(function(error) {
                    alert('An error occurred: ' + error.message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Change Password';
                })
                .changePassword({
                    email: currentUserEmail || document.getElementById('email').value,
                    currentPassword: currentPassword,
                    newPassword: newPassword
                });
        });

        // Handle cancel button
        document.getElementById('cancelPasswordChange').addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel? You may need to change your password to continue.')) {
                hidePasswordChangeModal();
            }
        });
    </script>
</body>
</html>
